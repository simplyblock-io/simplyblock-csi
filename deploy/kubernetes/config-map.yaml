# SPDX-License-Identifier: Apache-2.0
# Copyright (c) Arm Limited and Contributors
# Copyright (c) Intel Corporation
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: spdkcsi-cm
data:
  config.json: |-
    {
      "simplybk": {
        "uuid": "cdcd53dd-f8d2-4978-9063-a4f0189628b1",
        "ip": "35.170.65.79"
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: caching-node-restart-script-cm
data:
  restart_script.py: |
    import json, os, requests

    secret = json.loads(os.getenv("SPDKCSI_SECRET"))
    cluster_secret = secret['simplybk']['secret']

    cluster_config = json.loads(os.getenv("CLUSTER_CONFIG"))
    cluster_uuid = cluster_config['simplybk']['uuid']
    cluster_ip = cluster_config['simplybk']['ip']
    hostname = os.getenv('HOSTNAME')

    url = f'http://{cluster_ip}/cachingnode/recreate/{hostname}'
    headers = {
        'Authorization': f'{cluster_uuid} {cluster_secret}'
    }

    response = requests.get(url, headers=headers)

    print("Response Text:", response.text)
    print("Response Code:", response.status_code)
